# 使用虚拟地址访问内存全流程

进程内存管理
进程申请的内存完全由 struct mm_struct 中的 struct vm_area_struct 来管理，其次物理内存的访问需要经过mmu来查询页表项，如果页表项不存在就会发生缺页异常检查虚拟地址是否正确

1. 进程初始化： 当一个进程被创建时，内核为该进程创建一个虚拟地址空间，并初始化该控件的VMA列表。
2. 虚拟地址请求：当进程试图访问某个虚拟地址时，该地址会被mmu单元转换为进程的页表中的相应物理地址。如果该页表不错在就会触发缺页异常
3. 缺页异常处理
    - 内核会查找进程的VMA列表，已找到包含该虚拟地址的VMA结构
    - 内核检查VMA的权限字段，确定访问是否合法（读，写，执行等）
    - 如果地址不在任何VMA中，或者访问权限不匹配，如果当前缺页处于用户线程则内核就会发出 seg信号，内核线程另说
4. 页面加载或分配
    - 如果访问时合法的，内核根据VMA的类型决定下一步的操作
      - 匿名映射：分配新的物理页面并将其加载到物理内存中
      - 文件映射：从文件中读取相应的数据并将其加载到物理内存中
    - 内核会更新进程的页表，将新的物理页映射到请求的虚拟地址
5. 继续执行：页面加载完成后，内核恢复进程的执行，细腻地址现在已经可以被正常访问
6. 内存的释放和清理
    - 当进程终止和释放内存区域时，内核会清理相应的VMA，并释放与之关联的物理内存

### MMU在页表查询中的作用
1. MMU的功能
    - 地址转换：mmu是cpu内部或cpu紧密结合的硬件模块，专门负责将虚拟地址转换为物理地址。他通过查阅页表来完成虚拟地址到物理地址的映射
    - 权限检查：MMU 还负责检查页表项中的权限位（如读、写、执行），确保内存访问符合权限要求。
    - 异常触发：当 MMU 发现页表项的有效位为 0 或权限不足时，它会触发相应的异常（如缺页异常或访问权限异常）。
2. 页表查询流程
    - 当cpu执行一条指令涉及内存访问时，虚拟地址被送到MMU
    - MMU查阅页表，具体步骤通常为：
        - TLB 查找：首先在快表（TLB, Translation Lookaside Buffer）中查找映射，如果命中，直接返回物理地址。
        - 页表查找：如果 TLB 未命中，MMU 继续查找内存中的页表，根据页表项获取物理地址。
        - 判断有效位：检查页表项中的有效位（Present Bit）。如果有效位为 0，则说明页面不在内存中。
        - 触发异常：如果有效位为 0 或权限不匹配，MMU 会向 CPU 发起缺页异常或其他内存访问异常。
3. 操作系统的角色
    - 虽然页表的查询和初步判断由 MMU 完成，但操作系统负责管理页表的内容（如创建、更新页表），处理缺页异常，并在页面换入或换出时相应调整页表。
    - 操作系统提供页表的结构和管理策略，而具体的查找工作由 MMU 自动完成，无需操作系统干预。 


